<% if authorize_for :issue_templates, :new %>
  <div class="contextual">
    <%= link_to l(:label_new_templates), new_project_issue_template_path(@project), :class => 'icon icon-add' %>
  </div>
<% end %>
<h2><%= l(:issue_template) %></h2>

<% if @project.trackers.blank? %>
  <div class="nodata">
    <%= simple_format(l(:text_no_tracker_enabled)) %>
  </div>
<% end %>

<% if @notice -%>
  <div class="flash notice"><%= @notice -%></div>
<% end -%>


<% if @template_map.empty? %>
    <div class="template_box">
      <%= l(:no_issue_templates_for_this_project) %>
    </div>
<% end %>

<% @template_map.each_key do |tracker| %>
<h3 class="template_tracker"><%= tracker.name %></h3>
  <%= non_project_tracker_msg(is_project_tracker(tracker.id, @project)) %>

<table class="list issues">
  <thead>
    <tr>
      <th>#</th> 
      <th><%= l(:issue_template_name) %></th>
      <th><%= l(:field_tracker) %></th>
      <th><%= l(:field_author) %></th> 
      <th><%= l(:field_updated_on) %></th>
      <th><%= l(:field_is_default) %></th>
      <th><%= l(:label_enabled) %></th>
       <% if authorize_for("issue_templates", "edit") %>
      <th><%=l(:button_sort)%></th>
      <% end %>
    </tr>
  </thead>
  <tbody>
    <% @template_map[tracker].each do |issue_template| %>
      <tr class="<%= cycle("odd", "even") %> issue_template issue">
        <td><%= link_to h(issue_template.id),  {:controller => 'issue_templates', 
                 :action => 'show', :id => issue_template.id, :project_id => @project}, {:title => issue_template.note } %></td>
        <td><%= link_to h(issue_template.title),  {:controller => 'issue_templates',
                 :id => issue_template.id, :action => 'show'},
                 {:title => "#{html_escape(issue_template.note)}"} %>

          <a class="icon template_tooltip" href="#" title="<%= l(:label_preview) %>"
             onclick="checkExpand('template_description-<%= issue_template.id %>');"></a>
        </td>
        <td><%=h issue_template.tracker.name %></td>
        <td><%=h issue_template.author %></td>
        <td><%= format_time(issue_template.updated_on)%> </td>
        <td class="center"><%= checked_image issue_template.is_default? %></td>
        <td class="center"><%= checked_image issue_template.enabled? %></td>

        <% if authorize_for("issue_templates", "edit") %>
        <td>
            <%= link_to image_tag('2uparrow.png', :alt => l(:label_sort_highest)),
                        move_to_top_project_issue_template_path(@project, issue_template),
                        :title => l(:label_sort_highest),
                        :method => :put unless issue_template.first? %>
            <%= link_to image_tag('1uparrow.png', :alt => l(:label_sort_higher)),
                        move_higher_project_issue_template_path(@project, issue_template),
                        :title => l(:label_sort_higher),
                        :method => :put unless issue_template.first? %>
            <%= link_to image_tag('1downarrow.png', :alt => l(:label_sort_lower)),
                        move_lower_project_issue_template_path(@project, issue_template),
                        :title => l(:label_sort_lower),
                        :method => :put unless issue_template.last? %>
            <%= link_to image_tag('2downarrow.png', :alt => l(:label_sort_lowest)),
                        move_to_bottom_project_issue_template_path(@project, issue_template),
                        :title => l(:label_sort_lowest),
                        :method => :put unless issue_template.last? %>
        </td>
      <% end %>
      </tr>
      <tr class="<%= current_cycle %>" style="display: none;" id="template_description-<%= issue_template.id %>">
        <td class="description" colspan="8">
          <div class="wiki"><%= textilizable(issue_template.description) %></div></td>
      </tr>

    <% end %>
  </tbody>
</table>
<% end %>


<% unless @inherit_templates.blank? %>
  <p>&nbsp;</p>
  <h2><%=h "#{l(:label_inherited_templates)}" %></h2>

  <table class="list issues">
    <thead>
    <tr>
      <th>#</th>
      <th><%= l(:issue_template_name) %></th>
      <th><%= l(:field_tracker) %></th>
      <th><%= l(:field_author) %></th>
      <th><%= l(:field_updated_on) %></th>
      <th><%= l(:field_is_default) %></th>
      <th><%= l(:label_enabled) %></th>
    </tr>
    </thead>
    <tbody>
    <% @inherit_templates.each do |issue_template| %>
        <tr class="<%= cycle("odd", "even") %> issue_template issue">
          <td><%= link_to h(issue_template.id),  {:controller => 'issue_templates',
                :action => 'show', :id => issue_template.id,
                :project_id => issue_template.project_id }, {:title => issue_template.note } %></td>
          <td><%= link_to h(issue_template.title),  {:controller => 'issue_templates',
                                                     :id => issue_template.id, :action => 'show'},
                          {:title => "#{html_escape(issue_template.note)}"} %>

            <a class="icon template_tooltip" href="#" title="<%= l(:label_preview) %>"
               onclick="checkExpand('template_description-<%= issue_template.id %>');"></a>
          </td>
          <td><%=h issue_template.tracker.name %></td>
          <td><%=h issue_template.author %></td>
          <td><%= format_time(issue_template.updated_on)%> </td>
          <td class="center"><%= checked_image issue_template.is_default? %></td>
          <td class="center"><%= checked_image issue_template.enabled? %></td>
        </tr>
        <tr class="<%= current_cycle %>" style="display: none;" id="template_description-<%= issue_template.id %>">
          <td class="description" colspan="8">
            <div class="wiki"><%= textilizable(issue_template.description) %></div></td>
        </tr>
    <% end %>
    </tbody>
  </table>
<% end %>

<% unless  @globalIssueTemplates.blank? %>
  <p>&nbsp;</p>
  <h2><%=h "#{l(:global_issue_templates)}" %></h2>

  <p> <%= l(:only_admin_can_associate_global_template) %> </p>

  <table class="list issues">
    <thead>
    <tr>
      <th>#</th>
      <th><%= l(:issue_template_name) %></th>
      <th><%= l(:field_tracker) %></th>
      <th><%= l(:field_author) %></th>
      <th><%= l(:field_updated_on) %></th>
    </tr>
    </thead>
    <tbody>
    <% @globalIssueTemplates.each do |issue_template| %>
        <tr class="<%= cycle("odd", "even") %> issue_template issue">
          <td>
            <% if User.current.admin? %>
                 <%= link_to h(issue_template.id),  {:controller => 'global_issue_templates',
                                                  :action => 'show', :id => issue_template.id,
                                                  }, {:title => issue_template.note } %>
            <% else %>
                <%=h issue_template.id %>
            <% end %>
           </td>

          <td>
            <%= link_to h(issue_template.title),  {:controller => 'global_issue_templates',
                                                   :id => issue_template.id, :action => 'show'},
                        {:title => "#{html_escape(issue_template.note)}"} %>
            <a class="icon template_tooltip" href="#" title="<%= l(:label_preview) %>"
               onclick="checkExpand('global_template_description-<%= issue_template.id %>');"></a>
          </td>
          <td><%=h issue_template.tracker.name %></td>
          <td><%=h issue_template.author %></td>
          <td><%= format_time(issue_template.updated_on)%> </td>
        </tr>
        <tr class="<%= current_cycle %>" style="display: none;" id="global_template_description-<%= issue_template.id %>">
          <td class="description" colspan="8">
            <div class="wiki"><%= textilizable(issue_template.description) %></div></td>
        </tr>
    <% end %>
    </tbody>
  </table>

<% end %>
